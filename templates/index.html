<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∞èÁÜäAIÂä©Êâã</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.37/dist/vue.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.16/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.5.1/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.5.1/styles/github-dark.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            height: 100%;
            overflow: hidden;
            background-color: #121212; /* Dark page background */
        }

        .chat-container {
            display: flex;
            height: 100vh;
        }

        /* --- SIDEBAR STYLES (Dark Theme) --- */
        .sidebar {
            width: 260px;
            background-color: #202123;
            color: #ececec;
            padding: 15px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #303133;
            height: 100%;
            overflow-y: auto;
        }
        .sidebar .new-chat-button {
            background-color: #343541; color: #ececec; border: 1px solid #565869;
            padding: 10px 15px; border-radius: 5px; cursor: pointer; text-align: left;
            font-size: 0.9em; margin-bottom: 20px; transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        .sidebar .new-chat-button:hover { background-color: #40414f; }
        .sidebar .new-chat-button .icon { margin-right: 8px; }
        .sidebar .chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 20px; }
        .sidebar .chat-history h3 { font-size: 0.8em; color: #8e8ea0; margin-top: 0; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #303133;}
        
        /* ÂØπËØùÂàóË°®Ê†∑Âºè */
        .conversation-list { display: flex; flex-direction: column; gap: 8px; }
        .conversation-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px 10px; 
            border-radius: 5px; 
            cursor: pointer; 
            transition: background-color 0.2s;
            background-color: #2a2b32;
        }
        .conversation-item:hover { background-color: #343541; }
        .conversation-item.active { background-color: #3a3b47; }
        .conversation-title { 
            flex: 1; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            font-size: 0.9em;
        }
        .conversation-actions { display: flex; gap: 5px; }
        .action-btn { 
            background: none; 
            border: none; 
            color: #8e8ea0; 
            cursor: pointer; 
            font-size: 0.9em; 
            padding: 2px 5px;
            opacity: 0.7;
            transition: opacity 0.2s, color 0.2s;
        }
        .action-btn:hover { opacity: 1; }
        .action-btn.edit-btn { color: #4a90e2; }
        .action-btn.delete-btn { color: #e25c4a; }
        .action-btn.confirm-btn { color: #4CAF50; }
        .action-btn.cancel-btn { color: #FF5722; }
        
        .conversation-rename {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .rename-input {
            background-color: #40414f;
            border: 1px solid #565869;
            color: #d1d5db;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            flex-grow: 1;
            margin-right: 5px;
            outline: none;
        }
        
        .rename-input:focus {
            border-color: #4a90e2;
        }
        
        .rename-actions {
            display: flex;
            gap: 5px;
        }
        .no-conversations { 
            text-align: center; 
            color: #8e8ea0; 
            padding: 10px; 
            font-size: 0.9em; 
        }
        .sidebar .chat-history ul { list-style: none; padding: 0; margin: 0; }
        .sidebar .chat-history li { padding: 8px 10px; border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sidebar .chat-history li:hover { background-color: #2a2b32; }
        .sidebar .chat-history li.active { background-color: #343541; }
        .sidebar .sidebar-footer { padding-top: 15px; border-top: 1px solid #303133; }
        .sidebar .sidebar-footer button { background: none; border: none; color: #ececec; padding: 8px 10px; width: 100%; text-align: left; cursor: pointer; border-radius: 5px; font-size: 0.9em; }
        .sidebar .sidebar-footer button:hover { background-color: #2a2b32; }

        /* --- MAIN CHAT AREA STYLES (Dark Theme) --- */
        .main-chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #343541; /* Dark theme main chat area */
            color: #d1d5db; /* Text color for dark theme */
        }
        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        /* Welcome Message Dark Theme */
        .welcome-message {
            text-align: center; margin: auto; padding: 40px; max-width: 600px;
        }
        .welcome-message h1 { font-size: 2em; margin-bottom: 10px; color: #ececec; } /* Dark theme h1 */
        .welcome-message p { font-size: 1em; color: #b8b8b8; line-height: 1.6; } /* Dark theme p */
        .welcome-message .example-prompts { margin-top: 30px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .welcome-message .prompt-card { /* Dark theme prompt card */
            background-color: #40414f; padding: 15px; border-radius: 8px; cursor: pointer;
            width: calc(50% - 25px); box-sizing: border-box; transition: background-color 0.2s;
            border: 1px solid #565869; /* Border for dark theme card */
        }
        .welcome-message .prompt-card:hover { background-color: #4d4e5a; }
        .welcome-message .prompt-card h4 { margin: 0 0 5px 0; font-size: 0.9em; color: #ececec; } /* Dark theme card h4 */
        .welcome-message .prompt-card p { margin: 0; font-size: 0.8em; color: #a9a9a9; } /* Dark theme card p */

        /* Message Bubbles Dark Theme */
        .message-bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; line-height: 1.4; word-wrap: break-word; }
        .message-bubble.user {
            background-color: #007bff; /* Original user blue */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .message-bubble.ai {
            background-color: #4a4b54; /* AI message color for dark theme */
            color: #d1d5db;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        .message-bubble.ai .search-indicator { font-size: 0.8em; color: #9ca3af; margin-top: 5px; display: block; }
        .message-bubble.ai .search-indicator .icon { margin-right: 5px; }
        .message-bubble.ai .thinking-indicator { display: inline-block; width: 8px; height: 8px; background-color: #d1d5db; border-radius: 50%; animation: blink 1.4s infinite both; margin-left: 5px;}
        .message-bubble.ai .thinking-indicator:nth-child(2) { animation-delay: 0.2s; }
        .message-bubble.ai .thinking-indicator:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

        /* Markdown formatting for AI responses */
        .message-bubble.ai {
            overflow-wrap: break-word;
        }
        .message-bubble.ai pre {
            background-color: #2d2d2d;
            border-radius: 5px;
            padding: 10px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .message-bubble.ai code {
            background-color: #2d2d2d;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
        }
        .message-bubble.ai p {
            margin: 0 0 10px 0;
        }
        .message-bubble.ai ul, .message-bubble.ai ol {
            margin: 0 0 10px 0;
            padding-left: 20px;
        }

        /* --- MODIFIED INPUT AREA STYLES (Dark Theme) --- */
        .input-area-container {
            background-color: #2c2d33; /* Darker card for input area */
            border-radius: 28px;
            margin: 15px 20px;
            padding: 12px 15px;
            border: 1px solid #40414f; /* Border for dark card */
        }

        .input-wrapper {
            display: flex;
            align-items: flex-start;
        }

        .input-wrapper textarea {
            flex-grow: 1;
            border: none;
            background: transparent;
            padding: 10px 5px;
            font-size: 15px;
            color: #ececec; /* Text color for dark theme textarea */
            resize: none;
            outline: none;
            min-height: 24px;
            max-height: 150px;
            line-height: 1.5;
            overflow-y: auto;
        }
        .input-wrapper textarea::placeholder {
            color: #8e8ea0; /* Placeholder color for dark theme */
        }

        .controls-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            margin-top: 5px;
            border-top: 1px solid #40414f; /* Separator line for dark theme */
        }

        .left-controls, .right-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-button, .icon-button-style {
            border: none;
            background-color: transparent;
            padding: 8px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            color: #acacbe; /* Button text/icon color for dark theme */
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.2s, color 0.2s;
        }
        .control-button:hover, .icon-button-style:hover {
            background-color: #40414f; /* Hover effect for dark theme */
            color: #ececec;
        }

        .icon-button-style {
            border-radius: 50%;
            width: 38px;
            height: 38px;
            justify-content: center;
            font-size: 1.1em;
            padding: 0;
        }
        
        .btn-icon { font-size: 1.1em; }
        .dropdown-arrow { font-size: 0.8em; margin-left: 2px; }

        .control-button.active {
            background-color: #565869 !important; /* Highlighted background */
            color: #ececec !important; /* Highlighted text color */
        }

        /* #sendBtnÁöÑÈªòËÆ§Ê†∑ÂºèÁî±.icon-button-styleÊèê‰æõ */
        #sendBtn.active { /* Send button active state for dark theme */
            background-color: #4a90e2; /* A distinct active color for send */
            color: #ffffff;
        }
        #sendBtn.active:hover {
            background-color: #4282ce;
        }

        /* ÂÅúÊ≠¢ÊåâÈíÆÊ†∑Âºè */
        .stop-button {
            background-color: #e74c3c !important; /* Á∫¢Ëâ≤ËÉåÊôØ */
            color: #ffffff !important;
        }
        .stop-button:hover {
            background-color: #c0392b !important;
        }

        /* Ê∑±Â∫¶ÊÄùËÄÉÊåâÈíÆÊ†∑Âºè */
        .thinking-button {
            position: relative;
        }
        .thinking-button.active {
            background-color: #f39c12 !important;
            color: white !important;
        }

        /* Ê®°ÂûãÈÄâÊã©‰∏ãÊãâËèúÂçïÊ†∑Âºè */
        .model-selector {
            position: relative;
            display: inline-block;
        }
        
        .model-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            background-color: #2c2d33;
            border: 1px solid #40414f;
            border-radius: 8px;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            margin-bottom: 5px;
        }
        
        .model-option {
            padding: 10px 15px;
            color: #d1d5db;
            cursor: pointer;
            border-bottom: 1px solid #40414f;
            transition: background-color 0.2s;
        }
        
        .model-option:last-child {
            border-bottom: none;
        }
        
        .model-option:hover {
            background-color: #40414f;
        }
        
        .model-option.selected {
            background-color: #4a90e2;
            color: white;
        }
        
        .model-option .model-name {
            font-weight: bold;
            display: block;
        }
        
        .model-option .model-desc {
            font-size: 0.8em;
            color: #8e8ea0;
            margin-top: 2px;
        }

        /* ÂõæÁâá‰∏ä‰º†ÂíåÈ¢ÑËßàÊ†∑Âºè */
        .image-upload-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 8px;
            background-color: #40414f;
            border-radius: 8px;
        }
        
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            object-fit: cover;
        }
        
        .image-info {
            flex-grow: 1;
            color: #d1d5db;
            font-size: 0.9em;
        }
        
        .image-remove {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        
        .image-remove:hover {
            background-color: rgba(231, 76, 60, 0.1);
        }

        /* ÊÄùËÄÉËøáÁ®ãÊòæÁ§∫Ê†∑Âºè */
        .thinking-process {
            background-color: #3a3b47;
            border-left: 4px solid #f1c40f;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: #d1d5db;
        }
        
        .thinking-process .thinking-title {
            font-weight: bold;
            color: #f1c40f;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .thinking-process .thinking-content {
            white-space: pre-wrap;
            line-height: 1.4;
        }

        /* Êà™ÂõæÂäüËÉΩÊ†∑Âºè */
        .screenshot-button {
            position: relative;
        }
        
        .screenshot-button.active {
            background-color: #e67e22 !important;
            color: white !important;
        }

        /* ÂõæÁâáÁ≤òË¥¥ÊèêÁ§∫ */
        .paste-hint {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2c2d33;
            color: #d1d5db;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 100;
        }
        
        .paste-hint.show {
            opacity: 1;
        }

        .model-hint {
            text-align: left; /* Align with textarea start */
            font-size: 0.75em;
            color: #8e8ea0; /* Hint text color for dark theme */
            padding-top: 12px;
        }

        /* Êñá‰ª∂‰∏ä‰º†ÂäüËÉΩÊ†∑Âºè */
        .file-upload-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .file-upload-container {
            background-color: #2c2d33;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .file-upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .file-upload-header h3 {
            margin: 0;
            color: #ececec;
        }

        .file-upload-close {
            background: none;
            border: none;
            color: #8e8ea0;
            font-size: 1.2em;
            cursor: pointer;
        }

        .file-upload-content {
            border: 2px dashed #40414f;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
        }

        .file-upload-content p {
            color: #8e8ea0;
            margin: 10px 0;
        }

        .file-upload-icon {
            font-size: 2em;
            color: #4a90e2;
            margin-bottom: 10px;
        }

        .file-upload-input {
            display: none;
        }

        .file-upload-btn {
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .file-list {
            margin-top: 15px;
        }

        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background-color: #343541;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .file-list-item .file-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #d1d5db;
        }

        .file-list-item .file-type {
            padding: 2px 6px;
            background-color: #4a4b54;
            border-radius: 3px;
            margin: 0 8px;
            font-size: 0.8em;
            color: #acacbe;
        }

        .file-upload-buttons {
            text-align: right;
        }

        .file-upload-cancel {
            background-color: transparent;
            border: 1px solid #565869;
            color: #acacbe;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9em;
            margin-right: 10px;
        }

        .file-upload-submit {
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9em;
        }

        /* Áü•ËØÜÂ∫ìÊñá‰ª∂ÂàóË°®Ê†∑Âºè */
        .knowledge-files-container {
            margin-top: 15px;
            border-top: 1px solid #303133;
            padding-top: 15px;
        }

        .knowledge-files-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .knowledge-files-title h3 {
            font-size: 0.8em;
            color: #8e8ea0;
            margin: 0;
        }

        .knowledge-files-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .knowledge-file-item {
            padding: 5px 8px;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 0.85em;
            background-color: #2a2b32;
            color: #d1d5db;
            display: flex;
            align-items: center;
        }

        .knowledge-file-icon {
            margin-right: 8px;
            color: #4a90e2;
        }

        .knowledge-file-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .knowledge-file-date {
            font-size: 0.8em;
            color: #8e8ea0;
            margin-left: 5px;
        }

        /* Âà†Èô§ÊåâÈíÆÊ†∑Âºè */
        .delete-button {
            background: none;
            border: none;
            color: #8e8ea0;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 3px;
            margin-left: 8px;
            transition: color 0.2s, background-color 0.2s;
        }
        
        .delete-button:hover {
            color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
        }

        /* Âä†ËΩΩ‰∏≠Áä∂ÊÄÅ */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ÈîôËØØÊ∂àÊÅØÊ†∑Âºè */
        .error-message-container {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: auto;
            max-width: 80%;
        }
        
        .error-message {
            background-color: #fee2e2;
            color: #b91c1c;
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            text-align: center;
            font-size: 14px;
        }

        /* Ê∂àÊÅØ‰∏≠ÁöÑÂõæÁâáÊ†∑Âºè */
        .message-images {
            margin: 10px 0;
        }
        
        .message-image {
            margin-bottom: 10px;
        }
        
        .uploaded-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 8px;
            object-fit: cover;
            display: block;
        }
        
        .image-caption {
            font-size: 0.8em;
            color: #8e8ea0;
            margin-top: 5px;
        }
        
        .uploaded-images-container {
            margin-bottom: 10px;
        }
        
        /* ËßÜËßâÊåáÁ§∫Âô®Ê†∑Âºè */
        .vision-indicator {
            font-size: 0.8em;
            color: #9ca3af;
            margin-top: 5px;
            display: block;
        }
        
        .vision-indicator .icon {
            margin-right: 5px;
        }

        /* ‰∏ä‰º†Êñá‰ª∂ÊòæÁ§∫Âå∫ÂüüÊ†∑Âºè */
        .uploaded-files-display {
            background-color: #2c2d33;
            border-radius: 8px;
            margin: 15px 20px 0 20px;
            padding: 15px;
            border: 1px solid #40414f;
        }

        .uploaded-files-header {
            margin-bottom: 10px;
        }

        .uploaded-files-header h4 {
            margin: 0;
            color: #d1d5db;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .uploaded-files-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .uploaded-file-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background-color: #343541;
            border-radius: 6px;
            gap: 10px;
        }

        .uploaded-file-item .file-icon {
            color: #4a90e2;
            font-size: 1.1em;
        }

        .uploaded-file-item .file-name {
            flex-grow: 1;
            color: #d1d5db;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .uploaded-file-item .file-size {
            color: #8e8ea0;
            font-size: 0.8em;
        }

        .file-remove-btn {
            background: none;
            border: none;
            color: #8e8ea0;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.2s, background-color 0.2s;
        }

        .file-remove-btn:hover {
            color: #e74c3c;
            background-color: rgba(231, 76, 60, 0.1);
        }

        /* ÊÄùËÄÉËøáÁ®ãÂÆπÂô®Ê†∑Âºè */
        .thinking-container {
            background-color: #3a3b47;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #565869;
            color: #d1d5db;
        }
        
        .thinking-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            color: #f39c12;
        }
        
        .thinking-title i {
            margin-right: 8px;
        }
        
        .thinking-content {
            white-space: pre-wrap;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.5;
            color: #ececec;
        }

        /* Ê∑±Â∫¶ÊÄùËÄÉÊåâÈíÆÊ†∑Âºè */
        .thinking-button {
            position: relative;
        }
        
        .thinking-button.active {
            background-color: #f39c12 !important;
            color: white !important;
        }

        /* Êà™ÂõæÂäüËÉΩÊ†∑Âºè */

        /* ÂõæÁâáÁ≤òË¥¥ÊèêÁ§∫ */
        .paste-hint {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2c2d33;
            color: #d1d5db;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 100;
        }
        
        .paste-hint.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="chat-container">
            <aside class="sidebar">
                <button class="new-chat-button" @click="startNewChat">
                    <span class="icon">+</span> Êñ∞Âª∫ÂØπËØù
                </button>
                <div class="chat-history">
                    <h3>ÂØπËØùÂéÜÂè≤</h3>
                    <!-- ËÅäÂ§©ÂéÜÂè≤ÂàóË°® -->
                    <div class="conversation-list">
                        <div v-for="(chat, index) in chatHistory" :key="chat.id" 
                            class="conversation-item"
                            :class="{active: chat.id === currentConversationId}"
                            @click="loadChat(chat.id)">
                            <!-- Ê≠£Â∏∏ÊòæÁ§∫Ê®°Âºè -->
                            <div v-if="!(isRenaming && renamingId === chat.id)" class="conversation-title">
                                {{ chat.title || 'Êó†Ê†áÈ¢òÂØπËØù' }}
                            </div>
                            <!-- ÈáçÂëΩÂêçÊ®°Âºè -->
                            <div v-else class="conversation-rename">
                                <input 
                                    type="text" 
                                    v-model="newTitle" 
                                    :id="`rename-input-${chat.id}`"
                                    @keyup.enter="confirmRename"
                                    @keyup.esc="cancelRename"
                                    placeholder="ËæìÂÖ•Êñ∞Ê†áÈ¢ò"
                                    class="rename-input"
                                >
                                <div class="rename-actions">
                                    <button @click.stop="confirmRename" class="action-btn confirm-btn">
                                        <i class="fa fa-check"></i>
                                    </button>
                                    <button @click.stop="cancelRename" class="action-btn cancel-btn">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- ÂØπËØùÊìç‰ΩúÊåâÈíÆ -->
                            <div v-if="!(isRenaming && renamingId === chat.id)" class="conversation-actions">
                                <button @click.stop="startRenameConversation(chat.id, chat.title, $event)" 
                                        class="action-btn edit-btn">
                                    <i class="fa fa-edit"></i>
                                </button>
                                <button @click.stop="deleteConversation(chat.id, $event)" 
                                        class="action-btn delete-btn">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div v-if="chatHistory.length === 0" class="no-conversations">
                            Ê≤°ÊúâÂØπËØùÂéÜÂè≤
                        </div>
                    </div>
                </div>
                <div class="knowledge-files-container" v-if="knowledgeFiles.length > 0">
                    <div class="knowledge-files-title">
                        <h3>Â∑≤‰∏ä‰º†Êñá‰ª∂</h3>
                    </div>
                    <div class="knowledge-files-list">
                        <div v-for="file in knowledgeFiles" :key="file.id" class="knowledge-file-item">
                            <span class="knowledge-file-icon">
                                <i class="fa" :class="getFileIcon(file.file_type)"></i>
                            </span>
                            <span class="knowledge-file-name" :title="file.filename">{{ file.filename }}</span>
                            <span class="knowledge-file-date">{{ formatDate(file.upload_time) }}</span>
                            <button @click="deleteKnowledgeFile(file.id, file.filename)" class="delete-button">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </aside>
            <main class="main-chat-area">
                <!-- ÈîôËØØÊ∂àÊÅØÊèêÁ§∫ -->
                <div v-if="errorMessage" class="error-message-container">
                    <div class="error-message">
                        {{ errorMessage }}
                    </div>
                </div>
                
                <!-- ‰∏ä‰º†Êñá‰ª∂ÊòæÁ§∫Âå∫Âüü -->
                <div v-if="uploadedFiles.length > 0" class="uploaded-files-display">
                    <div class="uploaded-files-header">
                        <h4><i class="fa fa-file-o"></i> Â∑≤‰∏ä‰º†Êñá‰ª∂</h4>
                    </div>
                    <div class="uploaded-files-list">
                        <div v-for="(file, index) in uploadedFiles" :key="index" class="uploaded-file-item">
                            <span class="file-icon">
                                <i class="fa" :class="getFileIcon(getFileExtension(file.name))"></i>
                            </span>
                            <span class="file-name" :title="file.name">{{ file.name }}</span>
                            <span class="file-size">{{ formatFileSize(file.size) }}</span>
                            <button @click="removeUploadedFile(index)" class="file-remove-btn">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="chat-messages" ref="chatMessages">
                    <div v-if="messages.length === 0" class="welcome-message">
                        <h1>{{ getTimeBasedGreeting() }}ÔºåÊ¨¢Ëøé‰ΩøÁî®Â∞èÁÜäÂä©Êâã</h1>
                        <div class="example-prompts">
                            <div class="prompt-card" @click="usePrompt('‰ªãÁªç‰∏Ä‰∏ã‰Ω†ÊúâÂì™‰∫õÂäüËÉΩÔºü')">
                                <h4>‰∫ÜËß£ÂäüËÉΩ</h4>
                                <p>‰ªãÁªç‰∏Ä‰∏ã‰Ω†ÊúâÂì™‰∫õÂäüËÉΩÔºü</p>
                            </div>
                            <div class="prompt-card" @click="usePrompt('ÊêúÁ¥¢ÊúÄÊñ∞ÁöÑAIÊäÄÊúØËøõÂ±ï')">
                                <h4>ËÅîÁΩëÊêúÁ¥¢</h4>
                                <p>ÊêúÁ¥¢ÊúÄÊñ∞ÁöÑAIÊäÄÊúØËøõÂ±ï</p>
                            </div>
                            <div class="prompt-card" @click="usePrompt('Â∏ÆÊàëÂàÜÊûê‰∏Ä‰∏ã‰∏ä‰º†ÁöÑPDFÊñáÊ°£ÂÜÖÂÆπ')">
                                <h4>ÊñáÊ°£ÂàÜÊûê</h4>
                                <p>Â∏ÆÊàëÂàÜÊûê‰∏Ä‰∏ã‰∏ä‰º†ÁöÑPDFÊñáÊ°£ÂÜÖÂÆπ</p>
                            </div>
                            <div class="prompt-card" @click="usePrompt('ËØ∑Áî®PythonÂÜô‰∏Ä‰∏™ÁÆÄÂçïÁöÑËÅäÂ§©Êú∫Âô®‰∫∫')">
                                <h4>‰ª£Á†ÅÂä©Êâã</h4>
                                <p>ËØ∑Áî®PythonÂÜô‰∏Ä‰∏™ÁÆÄÂçïÁöÑËÅäÂ§©Êú∫Âô®‰∫∫</p>
                            </div>
                        </div>
                    </div>
                    <div v-for="(message, index) in messages" :key="index" :class="['message-bubble', message.role]">
                        <div v-if="message.role === 'ai' && message.thinking" class="thinking-container">
                            üêªÂ∞èÁÜäÊ≠£Âú®ÊÄùËÄÉ‰∏≠<span class="thinking-indicator"></span><span class="thinking-indicator"></span><span class="thinking-indicator"></span>
                        </div>
                        <!-- ÊòæÁ§∫ÊÄùËÄÉËøáÁ®ã -->
                        <div v-if="message.role === 'ai' && message.thinkingProcess" class="thinking-process">
                            <div class="thinking-title">
                                <i class="fa fa-lightbulb-o"></i>
                                ÊÄùËÄÉËøáÁ®ã
                            </div>
                            <div class="thinking-content" v-html="formatMessage(message.thinkingProcess)"></div>
                        </div>
                        <!-- ÊòæÁ§∫Áî®Êà∑‰∏ä‰º†ÁöÑÂõæÁâá -->
                        <div v-if="message.role === 'user' && message.images && message.images.length > 0" class="message-images">
                            <div v-for="(image, imgIndex) in message.images" :key="imgIndex" class="message-image">
                                <img :src="image.url" :alt="image.name" class="uploaded-image" />
                                <div class="image-caption">{{ image.name }}</div>
                            </div>
                        </div>
                        <div v-else v-html="formatMessage(message.content)"></div>
                        <span v-if="message.role === 'ai' && message.usedSearch" class="search-indicator">
                            <i class="fa fa-search icon"></i> ‰ΩøÁî®‰∫ÜËÅîÁΩëÊêúÁ¥¢
                        </span>
                        <span v-if="message.role === 'ai' && message.usedVision" class="vision-indicator">
                            <i class="fa fa-eye icon"></i> ‰ΩøÁî®‰∫ÜÂõæÂÉèÁêÜËß£
                        </span>
                    </div>
                </div>
                <div class="input-area-container">
                    <!-- ÂõæÁâá‰∏ä‰º†È¢ÑËßàÂå∫Âüü -->
                    <div v-if="uploadedImages.length > 0" class="uploaded-images-container">
                        <div v-for="(image, index) in uploadedImages" :key="index" class="image-upload-container">
                            <img :src="image.url" :alt="image.name" class="image-preview" />
                            <div class="image-info">
                                <div>{{ image.name }}</div>
                                <div style="font-size: 0.8em; color: #8e8ea0;">{{ formatFileSize(image.size) }}</div>
                            </div>
                            <button @click="removeUploadedImage(index)" class="image-remove">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-wrapper">
                        <div class="paste-hint" :class="{ show: showPasteHint }">
                            Êåâ Ctrl+V Á≤òË¥¥ÂõæÁâá
                        </div>
                        <textarea 
                            ref="messageInput"
                            v-model="userInput" 
                            @input="adjustTextareaHeight"
                            @keydown.enter.prevent="handleEnterKey"
                            @paste="handlePaste"
                            placeholder="ËæìÂÖ•Ê∂àÊÅØ..." 
                            rows="1">
                        </textarea>
                        <!-- ÈöêËóèÁöÑÂõæÁâá‰∏ä‰º†ËæìÂÖ• -->
                        <input type="file" ref="imageInput" class="file-upload-input" @change="onImageSelected" accept="image/*" multiple>
                        <!-- ÈöêËóèÁöÑÊñá‰ª∂‰∏ä‰º†ËæìÂÖ• -->
                        <input type="file" ref="documentInput" class="file-upload-input" @change="onDocumentSelected" accept=".pdf,.csv,.txt,.md,.xls,.xlsx,.docx,.doc,.json" multiple>
                    </div>
                    <div class="controls-toolbar">
                        <div class="left-controls">
                            <button 
                                :class="['control-button', { active: webSearchEnabled }]" 
                                @click="toggleWebSearch" 
                                title="ËÅîÁΩëÊêúÁ¥¢">
                                <i class="fa fa-search btn-icon"></i>
                                <span>ËÅîÁΩëÊêúÁ¥¢</span>
                            </button>
                            <button 
                                :class="['control-button', 'thinking-button', { active: deepThinkingEnabled }]" 
                                @click="toggleDeepThinking" 
                                title="Ê∑±Â∫¶ÊÄùËÄÉ">
                                <i class="fa fa-lightbulb-o btn-icon"></i>
                                <span>Ê∑±Â∫¶ÊÄùËÄÉ</span>
                            </button>
                            <button class="control-button" @click="toggleFileUpload" title="‰∏ä‰º†ÊñáÊ°£">
                                <i class="fa fa-upload btn-icon"></i>
                                <span>‰∏ä‰º†Êñá‰ª∂</span>
                            </button>
                            <!-- Âà†Èô§ÂõæÁâáÁêÜËß£ÊåâÈíÆ -->
                            <!-- Ê®°ÂûãÈÄâÊã©Âô® -->
                            <div class="model-selector">
                                <button class="control-button" @click="toggleModelDropdown" title="ÈÄâÊã©Ê®°Âûã">
                                    <i class="fa fa-cog btn-icon"></i>
                                    <span>{{ selectedModel.name }}</span>
                                    <i class="fa fa-chevron-down dropdown-arrow" :class="{ 'fa-chevron-up': showModelDropdown }"></i>
                                </button>
                                <div v-if="showModelDropdown" class="model-dropdown">
                                    <div v-for="model in availableModels" :key="model.id" 
                                         @click="selectModel(model)" 
                                         :class="['model-option', { selected: selectedModel.id === model.id }]">
                                        <span class="model-name">{{ model.name }}</span>
                                        <span class="model-desc">{{ model.description }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="right-controls">
                            <button 
                                v-if="isLoading"
                                class="icon-button-style stop-button" 
                                @click="stopGeneration" 
                                title="ÂÅúÊ≠¢ÁîüÊàê">
                                <i class="fa fa-stop"></i>
                            </button>
                            <button 
                                v-else
                                id="sendBtn" 
                                class="icon-button-style" 
                                :class="{ active: userInput.trim().length > 0 || uploadedImages.length > 0 || uploadedFiles.length > 0 }"
                                @click="sendMessage" 
                                :disabled="isLoading">
                                <i class="fa fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Êñá‰ª∂‰∏ä‰º†Ê®°ÊÄÅÊ°Ü -->
        <div v-if="showFileUpload" class="file-upload-overlay" @click.self="toggleFileUpload">
            <div class="file-upload-container">
                <div class="file-upload-header">
                    <h3>‰∏ä‰º†Êñá‰ª∂</h3>
                    <button class="file-upload-close" @click="toggleFileUpload">&times;</button>
                </div>
                <div class="file-upload-content" 
                     @dragover.prevent="onDragOver" 
                     @dragleave.prevent="onDragLeave" 
                     @drop.prevent="onFileDrop"
                     :class="{ 'drag-over': isDragOver }">
                    <div class="file-upload-icon">
                        <i class="fa fa-cloud-upload"></i>
                    </div>
                    <p>ÊãñÊîæÊñá‰ª∂Âà∞ËøôÈáåÔºåÊàñ</p>
                    <input type="file" ref="fileInput" class="file-upload-input" @change="onFileSelected" accept=".pdf,.csv,.txt,.md,.xls,.xlsx,.docx,.doc,.json">
                    <button class="file-upload-btn" @click="triggerFileInput">ÈÄâÊã©Êñá‰ª∂</button>
                    <p>ÊîØÊåÅÁöÑÊ†ºÂºè: PDF, CSV, TXT, MD, XLS, XLSX, DOCX, DOC, JSON</p>
                </div>
                <div class="file-list" v-if="selectedFiles.length > 0">
                    <div v-for="(file, index) in selectedFiles" :key="index" class="file-list-item">
                        <span class="file-name">{{ file.name }}</span>
                        <span class="file-type">{{ getFileExtension(file.name).toUpperCase() }}</span>
                        <button class="control-button" @click="removeFile(index)">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="file-upload-buttons">
                    <button class="file-upload-cancel" @click="toggleFileUpload">ÂèñÊ∂à</button>
                    <button class="file-upload-submit" @click="uploadFiles" :disabled="isUploading || selectedFiles.length === 0">
                        <span v-if="isUploading">
                            <i class="loading-spinner"></i> ‰∏ä‰º†‰∏≠...
                        </span>
                        <span v-else>‰∏ä‰º†</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÈÖçÁΩÆmarked.js‰ª•ÊîØÊåÅËØ≠Ê≥ïÈ´ò‰∫Æ
        marked.setOptions({
            highlight: function(code, lang) {
                try {
                    return hljs.highlight(code, { language: lang }).value;
                } catch (e) {
                    return hljs.highlightAuto(code).value;
                }
            },
            breaks: true
        });

        // ÂàõÂª∫VueÂ∫îÁî®
        const { createApp, ref, reactive, onMounted, nextTick, computed } = Vue;

        const app = createApp({
            setup() {
                // Áä∂ÊÄÅÂèòÈáè
                const userInput = ref('');
                const messages = ref([]);
                const chatHistory = ref([]);
                const currentChatIndex = ref(0);
                const webSearchEnabled = ref(false);
                const isLoading = ref(false);
                const showFileUpload = ref(false);
                const selectedFiles = ref([]);
                const isDragOver = ref(false);
                const isUploading = ref(false);
                const knowledgeFiles = ref([]);
                const isRenaming = ref(false);
                const renamingId = ref(null);
                const newTitle = ref('');
                const currentConversationId = ref(null);
                const errorMessage = ref('');
                const ws = ref(null);
                const useWebSocket = ref(true);
                
                // Êñ∞Â¢ûÁä∂ÊÄÅÂèòÈáè
                const deepThinkingEnabled = ref(false);
                const uploadedImages = ref([]);
                const uploadedFiles = ref([]);
                const visionModeEnabled = ref(false);
                const showPasteHint = ref(false);
                const showModelDropdown = ref(false);
                const selectionRect = ref(null);
                const selectedModel = ref({
                    id: 'qwen-max',
                    name: 'Qwen-Max',
                    description: 'ÊúÄÂº∫Â§ßÁöÑÈÄöÁî®Ê®°Âûã'
                });
                const availableModels = ref([
                    {
                        id: 'qwen-max',
                        name: 'Qwen-Max',
                        description: 'ÊúÄÂº∫Â§ßÁöÑÈÄöÁî®Ê®°Âûã',
                        supports_vision: false,
                        supports_thinking: false
                    },
                    {
                        id: 'qwen-plus',
                        name: 'Qwen-Plus',
                        description: 'Âπ≥Ë°°ÊÄßËÉΩÂíåÊïàÁéáÁöÑÊ®°Âûã',
                        supports_vision: false,
                        supports_thinking: false
                    },
                    {
                        id: 'qwen-plus-latest',
                        name: 'Qwen-Plus-Latest',
                        description: 'ÊúÄÊñ∞ÁâàÊú¨ÔºåÊîØÊåÅÊÄùËÄÉÂíåÈùûÊÄùËÄÉÂàáÊç¢',
                        supports_vision: false,
                        supports_thinking: true
                    },
                    {
                        id: 'qwen3-235b-a22b',
                        name: 'Qwen3-235B',
                        description: 'ÊúÄÊñ∞ÁöÑQwen3Ê®°ÂûãÔºåÊîØÊåÅÊ∑±Â∫¶ÊÄùËÄÉ',
                        supports_vision: false,
                        supports_thinking: true
                    },
                    {
                        id: 'qwen-vl-max',
                        name: 'Qwen-VL-Max',
                        description: 'ËßÜËßâÁêÜËß£Ê®°ÂûãÔºåÊîØÊåÅÂõæÁâáÂàÜÊûê',
                        supports_vision: true,
                        supports_thinking: false
                    },
                    {
                        id: 'deepseek-r1',
                        name: 'DeepSeek-R1',
                        description: 'Ê∑±Â∫¶ÊÄùËÄÉÊ®°ÂûãÔºåËá™Âä®ÂºÄÂêØÊÄùËÄÉËøáÁ®ã',
                        supports_vision: false,
                        supports_thinking: true,
                        force_thinking: true
                    }
                ]);
                
                // DOMÂºïÁî®
                const chatMessages = ref(null);
                const messageInput = ref(null);
                const fileInput = ref(null);
                const imageInput = ref(null);
                const documentInput = ref(null);
                
                // APIÂü∫Á°ÄURL
                const apiBaseUrl = window.location.origin;
                
                // Ê†πÊçÆÊó∂Èó¥ËøîÂõûÈóÆÂÄôËØ≠
                function getTimeBasedGreeting() {
                    const hour = new Date().getHours();
                    if (hour >= 5 && hour < 12) {
                        return 'Êó©‰∏äÂ•Ω';
                    } else if (hour >= 12 && hour < 14) {
                        return '‰∏≠ÂçàÂ•Ω';
                    } else if (hour >= 14 && hour < 18) {
                        return '‰∏ãÂçàÂ•Ω';
                    } else {
                        return 'Êôö‰∏äÂ•Ω';
                    }
                }
                
                // ÊµèËßàÂô®ÂÖºÂÆπÊÄßÊ£ÄÊü•Âíå‰øÆÂ§ç
                function ensureBrowserCompatibility() {
                    // Á°Æ‰øùconfirmÂáΩÊï∞Â≠òÂú®‰∏îÂèØÁî®
                    if (typeof window.confirm !== 'function') {
                        window.confirm = function(message) {
                            return window.alert(message + '\n\nÁÇπÂáªÁ°ÆÂÆöÁªßÁª≠ÔºåÂèñÊ∂àÂàôÂÖ≥Èó≠Ê≠§ÂØπËØùÊ°Ü') !== undefined;
                        };
                    }
                    
                    // Á°Æ‰øùconsoleÂØπË±°Â≠òÂú®
                    if (typeof console === 'undefined') {
                        window.console = {
                            log: function() {},
                            error: function() {},
                            warn: function() {},
                            info: function() {}
                        };
                    }
                    
                    // Ê£ÄÊü•Âπ∂‰øÆÂ§ç‰∫ã‰ª∂Â§ÑÁêÜ
                    if (!Event.prototype.stopPropagation) {
                        Event.prototype.stopPropagation = function() {
                            this.cancelBubble = true;
                        };
                    }
                    
                    // Ê£ÄÊü•Âπ∂‰øÆÂ§çpreventDefault
                    if (!Event.prototype.preventDefault) {
                        Event.prototype.preventDefault = function() {
                            this.returnValue = false;
                        };
                    }
                }
                
                // ÂÆâÂÖ®ÁöÑÁ°ÆËÆ§ÂØπËØùÊ°Ü
                function safeConfirm(message) {
                    try {
                        // Â∞ùËØï‰ΩøÁî®ÂéüÁîüconfirm
                        if (typeof window.confirm === 'function') {
                            return window.confirm(message);
                        }
                        
                        // Â§áÁî®ÊñπÊ°àÔºö‰ΩøÁî®Ëá™ÂÆö‰πâÁ°ÆËÆ§
                        const result = prompt(message + '\n\nËæìÂÖ• "yes" Êàñ "y" Á°ÆËÆ§ÔºåÂÖ∂‰ªñ‰ªª‰ΩïÂÜÖÂÆπÂèñÊ∂àÔºö');
                        return result && (result.toLowerCase() === 'yes' || result.toLowerCase() === 'y');
                    } catch (error) {
                        console.error('Á°ÆËÆ§ÂØπËØùÊ°ÜÂá∫Èîô:', error);
                        // ÊúÄÂêéÁöÑÂ§áÁî®ÊñπÊ°à
                        return prompt('Á°ÆËÆ§Êìç‰ΩúÔºüËæìÂÖ• "yes" Á°ÆËÆ§Ôºö') === 'yes';
                    }
                }
                
                // ÂÆâÂÖ®ÁöÑ‰∫ã‰ª∂ÂÅúÊ≠¢‰º†Êí≠
                function safeStopPropagation(event) {
                    try {
                        if (event && typeof event.stopPropagation === 'function') {
                            event.stopPropagation();
                        } else if (event) {
                            event.cancelBubble = true;
                        }
                    } catch (error) {
                        console.error('ÂÅúÊ≠¢‰∫ã‰ª∂‰º†Êí≠Êó∂Âá∫Èîô:', error);
                    }
                }
                
                // ÂÆâÂÖ®ÁöÑ‰∫ã‰ª∂ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
                function safePreventDefault(event) {
                    try {
                        if (event && typeof event.preventDefault === 'function') {
                            event.preventDefault();
                        } else if (event) {
                            event.returnValue = false;
                        }
                    } catch (error) {
                        console.error('ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫Êó∂Âá∫Èîô:', error);
                    }
                }

                // ÂàùÂßãÂåñ
                onMounted(async () => {
                    // Á°Æ‰øùÊµèËßàÂô®ÂÖºÂÆπÊÄß
                    ensureBrowserCompatibility();
                    
                    console.log('VueÂ∫îÁî®Â∑≤ÊåÇËΩΩÔºåÂºÄÂßãÂàùÂßãÂåñ...');
                    
                    // ÂàùÂßãÂåñWebSocketËøûÊé•
                    initWebSocket();
                    
                    // Âä†ËΩΩÂèØÁî®Ê®°Âûã
                    await fetchAvailableModels();
                    
                    // Âä†ËΩΩÂØπËØùÂéÜÂè≤
                    await loadChatHistory();
                    
                    // Âä†ËΩΩÁü•ËØÜÂ∫ìÊñá‰ª∂
                    await fetchKnowledgeFiles();
                    
                    // Â¶ÇÊûúÊúâÂØπËØùÂéÜÂè≤ÔºåÂä†ËΩΩÁ¨¨‰∏Ä‰∏™ÂØπËØù
                    if (chatHistory.value.length > 0) {
                        loadChat(chatHistory.value[0].id);
                    }
                    
                    console.log('ÂàùÂßãÂåñÂÆåÊàê');
                });
                
                // ËÆæÁΩÆWebSocketËøûÊé•
                async function initWebSocket() {
                    // ‰ΩøÁî®ÂΩìÂâçÁ´ØÂè£Âè∑Êó†ÁºùÂàáÊç¢ÂçèËÆÆ
                    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
                    
                    try {
                        ws.value = new WebSocket(wsUrl);
                        
                        // Â§ÑÁêÜÊ∂àÊÅØ
                        ws.value.onmessage = (event) => {
                            const data = JSON.parse(event.data);
                            
                            if (data.error) {
                                // ÊòæÁ§∫ÈîôËØØ
                                errorMessage.value = data.error;
                                setTimeout(() => {
                                    errorMessage.value = '';
                                }, 5000);
                                isLoading.value = false;
                                return;
                            }
                            
                            // Â§ÑÁêÜÂÅúÊ≠¢ÂìçÂ∫î
                            if (data.stopped) {
                                console.log('Êî∂Âà∞ÂÅúÊ≠¢Á°ÆËÆ§');
                                return;
                            }
                            
                            if (data.stopped_complete) {
                                console.log('ÂÅúÊ≠¢ÂÆåÊàêÔºåÈÉ®ÂàÜÂìçÂ∫î:', data.partial_response);
                                isLoading.value = false;
                                
                                // Êõ¥Êñ∞ÊúÄÂêé‰∏ÄÊù°AIÊ∂àÊÅØ
                                const lastMessage = messages.value[messages.value.length - 1];
                                if (lastMessage && lastMessage.role === 'ai') {
                                    lastMessage.thinking = false;
                                    if (!lastMessage.content.includes('[ÂØπËØùÂ∑≤ÂÅúÊ≠¢]')) {
                                        lastMessage.content += '\n\n[ÂØπËØùÂ∑≤ÂÅúÊ≠¢]';
                                    }
                                }
                                
                                // Â¶ÇÊûúÊúçÂä°Âô®ËøîÂõû‰∫ÜÂØπËØùIDÔºåÊõ¥Êñ∞ÂΩìÂâçÂØπËØùID
                                if (data.conversation_id) {
                                    currentConversationId.value = data.conversation_id;
                                }
                                return;
                            }
                            
                            if (data.new_conversation) {
                                // ÊúçÂä°Âô®ÂàõÂª∫‰∫ÜÊñ∞ÂØπËØù
                                const newConversation = data.new_conversation;
                                console.log('Êñ∞ÂØπËØùÂàõÂª∫ÊàêÂäü:', newConversation);
                                currentConversationId.value = newConversation.id;
                                
                                // Â¶ÇÊûúÂØπËØù‰∏çÂú®ÂàóË°®‰∏≠ÔºåÊ∑ªÂä†Âà∞ÂàóË°®
                                const existingIndex = chatHistory.value.findIndex(c => c.id === newConversation.id);
                                if (existingIndex === -1) {
                                    chatHistory.value.unshift(newConversation);
                                }
                            }
                            
                            if (data.chunk) {
                                // Ê∑ªÂä†Âà∞ÂΩìÂâçÊ∂àÊÅØ
                                const lastMessage = messages.value[messages.value.length - 1];
                                if (lastMessage && lastMessage.role === 'ai') {
                                    const chunk = data.chunk;
                                    
                                    // Â¶ÇÊûúËøòÊ≤°ÊúâÂàùÂßãÂåñÊÄùËÄÉÁä∂ÊÄÅÔºåÊ£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÊÄùËÄÉÊ†áËÆ∞
                                    if (lastMessage.thinkingProcess === undefined) {
                                        lastMessage.thinkingProcess = '';
                                        lastMessage.isThinking = false;
                                    }
                                    
                                    // Á¥ØÁßØÂΩìÂâçÂùóÂà∞ÁºìÂÜ≤Âå∫ËøõË°åÊ£ÄÊµã
                                    if (!lastMessage.chunkBuffer) {
                                        lastMessage.chunkBuffer = '';
                                    }
                                    lastMessage.chunkBuffer += chunk;
                                    
                                    // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÊÄùËÄÉËøáÁ®ãÊ†áËÆ∞
                                    if (lastMessage.chunkBuffer.includes('**ü§î ÊÄùËÄÉËøáÁ®ãÔºö**')) {
                                        console.log('Ê£ÄÊµãÂà∞ÊÄùËÄÉËøáÁ®ãÂºÄÂßã');
                                        lastMessage.isThinking = true;
                                        lastMessage.thinking = true;
                                        
                                        // ÊèêÂèñÊÄùËÄÉÊ†áÈ¢òÂêéÁöÑÂÜÖÂÆπ
                                        const parts = lastMessage.chunkBuffer.split('**ü§î ÊÄùËÄÉËøáÁ®ãÔºö**');
                                        if (parts.length > 1) {
                                            lastMessage.thinkingProcess = parts[1];
                                        }
                                        lastMessage.chunkBuffer = ''; // Ê∏ÖÁ©∫ÁºìÂÜ≤Âå∫
                                    }
                                    // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÂõûÁ≠îÊ†áËÆ∞
                                    else if (lastMessage.chunkBuffer.includes('**üí° ÂõûÁ≠îÔºö**')) {
                                        console.log('Ê£ÄÊµãÂà∞ÂõûÁ≠îËøáÁ®ãÂºÄÂßã');
                                        lastMessage.isThinking = false;
                                    lastMessage.thinking = false;
                                        
                                        // ÊèêÂèñÂõûÁ≠îÊ†áÈ¢òÂêéÁöÑÂÜÖÂÆπ
                                        const parts = lastMessage.chunkBuffer.split('**üí° ÂõûÁ≠îÔºö**');
                                        if (parts.length > 1) {
                                            lastMessage.content += parts[1];
                                        }
                                        lastMessage.chunkBuffer = ''; // Ê∏ÖÁ©∫ÁºìÂÜ≤Âå∫
                                    }
                                    // Â¶ÇÊûúÊ≠£Âú®ÊÄùËÄÉÈò∂ÊÆµÔºåÁõ¥Êé•ËøΩÂä†Âà∞ÊÄùËÄÉÂÜÖÂÆπ
                                    else if (lastMessage.isThinking === true) {
                                        lastMessage.thinkingProcess += chunk;
                                        // ‰øùÊåÅÈÉ®ÂàÜÁºìÂÜ≤Âå∫‰ª•Ê£ÄÊµãÊ†áËÆ∞ËæπÁïå
                                        if (lastMessage.chunkBuffer.length > 50) {
                                            lastMessage.chunkBuffer = lastMessage.chunkBuffer.slice(-20);
                                        }
                                    }
                                    // Âê¶ÂàôËøΩÂä†Âà∞ÂõûÁ≠îÂÜÖÂÆπ
                                    else {
                                        lastMessage.content += chunk;
                                        lastMessage.thinking = false;
                                        // ‰øùÊåÅÈÉ®ÂàÜÁºìÂÜ≤Âå∫‰ª•Ê£ÄÊµãÊ†áËÆ∞ËæπÁïå
                                        if (lastMessage.chunkBuffer.length > 50) {
                                            lastMessage.chunkBuffer = lastMessage.chunkBuffer.slice(-20);
                                        }
                                    }
                                    
                                    scrollToBottom();
                                }
                            } else if (data.complete) {
                                // ÂΩìÊ∂àÊÅØÊé•Êî∂ÂÆåÊàê
                                isLoading.value = false;
                                
                                // Â¶ÇÊûúÊúçÂä°Âô®ËøîÂõû‰∫ÜÂØπËØùIDÔºåÊõ¥Êñ∞ÂΩìÂâçÂØπËØùID
                                if (data.conversation_id) {
                                    currentConversationId.value = data.conversation_id;
                                }
                            }
                        };
                        
                        // ÊàêÂäüËøûÊé•
                        ws.value.onopen = () => {
                            console.log('WebSocketËøûÊé•Â∑≤Âª∫Á´ã');
                            useWebSocket.value = true;
                        };
                        
                        // ÈîôËØØÂ§ÑÁêÜ
                        ws.value.onerror = (error) => {
                            console.error('WebSocketÈîôËØØ:', error);
                            useWebSocket.value = false;
                        };
                        
                        // ÂÖ≥Èó≠Â§ÑÁêÜ
                        ws.value.onclose = () => {
                            console.log('WebSocketËøûÊé•Â∑≤ÂÖ≥Èó≠');
                            useWebSocket.value = false;
                            // Â∞ùËØïÈáçÊñ∞ËøûÊé•
                            setTimeout(initWebSocket, 3000);
                        };
                    } catch (error) {
                        console.error('WebSocketÂàùÂßãÂåñÈîôËØØ:', error);
                        useWebSocket.value = false;
                    }
                }

                // ÊñπÊ≥ï
                function adjustTextareaHeight() {
                    if (!messageInput.value) return;
                    
                    // ÈáçÁΩÆÈ´òÂ∫¶‰ª•Ëé∑ÂèñÊ≠£Á°ÆÁöÑscrollHeight
                    messageInput.value.style.height = 'auto';
                    
                    // ËÆæÁΩÆÊñ∞È´òÂ∫¶
                    const newHeight = Math.min(messageInput.value.scrollHeight, 150);
                    messageInput.value.style.height = `${newHeight}px`;
                }

                function scrollToBottom() {
                    nextTick(() => {
                        if (chatMessages.value) {
                            chatMessages.value.scrollTop = chatMessages.value.scrollHeight;
                        }
                    });
                }

                function formatMessage(content) {
                    // ‰ΩøÁî®markedËΩ¨Êç¢Markdown
                    try {
                        return marked.parse(content);
                    } catch (e) {
                        console.error('MarkdownËß£ÊûêÈîôËØØ:', e);
                        return content;
                    }
                }

                function formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toLocaleDateString();
                }

                function formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }

                function getFileIcon(fileType) {
                    const iconMap = {
                        'pdf': 'fa-file-pdf-o',
                        'csv': 'fa-file-text-o',
                        'txt': 'fa-file-text-o',
                        'md': 'fa-file-text-o',
                        'xls': 'fa-file-excel-o',
                        'xlsx': 'fa-file-excel-o',
                        'doc': 'fa-file-word-o',
                        'docx': 'fa-file-word-o',
                        'json': 'fa-file-code-o'
                    };
                    return iconMap[fileType] || 'fa-file-o';
                }

                function getFileExtension(filename) {
                    return filename.split('.').pop().toLowerCase();
                }

                function usePrompt(prompt) {
                    userInput.value = prompt;
                    adjustTextareaHeight();
                    messageInput.value.focus();
                }

                function toggleWebSearch() {
                    webSearchEnabled.value = !webSearchEnabled.value;
                }

                function toggleDeepThinking() {
                    deepThinkingEnabled.value = !deepThinkingEnabled.value;
                }

                function toggleModelDropdown() {
                    showModelDropdown.value = !showModelDropdown.value;
                }

                function selectModel(model) {
                    selectedModel.value = model;
                    showModelDropdown.value = false;
                    
                    // Â¶ÇÊûúÈÄâÊã©‰∫Üdeepseek-r1ÔºåËá™Âä®ÂºÄÂêØÊ∑±Â∫¶ÊÄùËÄÉ
                    if (model.id === 'deepseek-r1') {
                        deepThinkingEnabled.value = true;
                    }
                }

                function triggerImageUpload() {
                    imageInput.value.click();
                }

                // Â§ÑÁêÜÂõæÁâáÈÄâÊã©
                function onImageSelected(event) {
                    const files = Array.from(event.target.files);
                    files.forEach(file => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                uploadedImages.value.push({
                                    file: file,
                                    url: e.target.result,
                                    name: file.name,
                                    size: file.size
                                });
                                
                                // Ëá™Âä®ÂêØÁî®ËßÜËßâÊ®°ÂºèÂπ∂ÂàáÊç¢Âà∞Qwen-VL-MaxÊ®°Âûã
                                visionModeEnabled.value = true;
                                const visionModel = availableModels.value.find(m => m.id === 'qwen-vl-max');
                                if (visionModel) {
                                    selectedModel.value = visionModel;
                                }
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                    // Ê∏ÖÁ©∫input
                    event.target.value = '';
                }

                function removeUploadedImage(index) {
                    uploadedImages.value.splice(index, 1);
                }

                function handlePaste(event) {
                    const items = event.clipboardData.items;
                    for (let i = 0; i < items.length; i++) {
                        const item = items[i];
                        if (item.type.indexOf('image') !== -1) {
                            const file = item.getAsFile();
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                uploadedImages.value.push({
                                    file: file,
                                    url: e.target.result,
                                    name: `Á≤òË¥¥ÁöÑÂõæÁâá_${Date.now()}.png`,
                                    size: file.size
                                });
                            };
                            reader.readAsDataURL(file);
                            
                            // ÊòæÁ§∫Á≤òË¥¥ÊèêÁ§∫
                            showPasteHint.value = true;
                            setTimeout(() => {
                                showPasteHint.value = false;
                            }, 2000);
                            
                            event.preventDefault();
                            break;
                        }
                    }
                }

                function toggleScreenshot() {
                    if (isScreenshotMode.value) {
                        isScreenshotMode.value = false;
                    } else {
                        isScreenshotMode.value = true;
                        // Ë∞ÉÁî®Êà™ÂõæÂäüËÉΩ
                        captureScreenshot();
                    }
                }

                async function captureScreenshot() {
                    try {
                        // Ê£ÄÊü•ÊòØÂê¶ÊîØÊåÅScreen Capture API
                        if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                            const stream = await navigator.mediaDevices.getDisplayMedia({
                                video: { mediaSource: 'screen' }
                            });
                            
                            // ÂàõÂª∫videoÂÖÉÁ¥†Êù•ÊçïËé∑Êà™Âõæ
                            const video = document.createElement('video');
                            video.srcObject = stream;
                            video.play();
                            
                            video.addEventListener('loadedmetadata', () => {
                                const canvas = document.createElement('canvas');
                                canvas.width = video.videoWidth;
                                canvas.height = video.videoHeight;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(video, 0, 0);
                                
                                // ÂÅúÊ≠¢ËßÜÈ¢ëÊµÅ
                                stream.getTracks().forEach(track => track.stop());
                                
                                // Â∞ÜcanvasËΩ¨Êç¢‰∏∫blob
                                canvas.toBlob((blob) => {
                                    const reader = new FileReader();
                                    reader.onload = (e) => {
                                        uploadedImages.value.push({
                                            file: blob,
                                            url: e.target.result,
                                            name: `Êà™Âõæ_${new Date().toLocaleString()}.png`,
                                            size: blob.size
                                        });
                                    };
                                    reader.readAsDataURL(blob);
                                }, 'image/png');
                                
                                isScreenshotMode.value = false;
                            });
                        } else {
                            alert('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÊà™ÂõæÂäüËÉΩ');
                            isScreenshotMode.value = false;
                        }
                    } catch (error) {
                        console.error('Êà™ÂõæÂ§±Ë¥•:', error);
                        alert('Êà™ÂõæÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ');
                        isScreenshotMode.value = false;
                    }
                }

                function toggleFileUpload() {
                    showFileUpload.value = !showFileUpload.value;
                    selectedFiles.value = [];
                    isDragOver.value = false;
                }

                async function sendMessage() {
                    const message = userInput.value.trim();
                    const hasImages = uploadedImages.value.length > 0;
                    
                    if ((!message && !hasImages) || isLoading.value) return;

                    // ÂáÜÂ§áÁî®Êà∑Ê∂àÊÅØÂØπË±°
                    const userMessage = {
                        role: 'user',
                        content: message || 'ËØ∑ÂàÜÊûêËøô‰∫õÂõæÁâá'
                    };
                    
                    // Â¶ÇÊûúÊúâÂõæÁâáÔºåÊ∑ªÂä†ÂõæÁâá‰ø°ÊÅØ
                    if (hasImages) {
                        userMessage.images = uploadedImages.value.map(img => ({
                            url: img.url,
                            name: img.name
                        }));
                    }

                    // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
                    messages.value.push(userMessage);
                    userInput.value = '';
                    adjustTextareaHeight();
                    scrollToBottom();

                    // Ê∑ªÂä†AIÊÄùËÄÉÁä∂ÊÄÅ
                    const aiMessageIndex = messages.value.length;
                    messages.value.push({ role: 'ai', content: '', thinking: true });
                    scrollToBottom();

                    isLoading.value = true;
                    
                    // ÂáÜÂ§áÂèëÈÄÅÁöÑÊï∞ÊçÆ
                    const sendData = {
                        message: message || 'ËØ∑ÂàÜÊûêËøô‰∫õÂõæÁâá',
                        web_search: webSearchEnabled.value,
                        deep_thinking: deepThinkingEnabled.value,
                        model: selectedModel.value.id,
                        conversation_id: currentConversationId.value
                    };
                    
                    // Â¶ÇÊûúÊúâÂõæÁâáÔºåÊ∑ªÂä†ÂõæÁâáÊï∞ÊçÆ
                    if (hasImages) {
                        sendData.images = [];
                        for (const img of uploadedImages.value) {
                            // Â∞ÜÂõæÁâáËΩ¨Êç¢‰∏∫base64
                            const base64 = img.url.split(',')[1];
                            sendData.images.push({
                                data: base64,
                                name: img.name,
                                type: img.file.type,
                                url: img.url  // Ê∑ªÂä†ÂÆåÊï¥ÁöÑdata URL
                            });
                        }
                    }
                    
                    // Ê∏ÖÁ©∫‰∏ä‰º†ÁöÑÂõæÁâá
                    uploadedImages.value = [];
                    
                    // ‰ΩøÁî®WebSocketÊàñHTTPËØ∑Ê±Ç
                    if (ws.value && ws.value.readyState === WebSocket.OPEN && useWebSocket.value) {
                        try {
                            // ÂèëÈÄÅWebSocketÊ∂àÊÅØ
                            ws.value.send(JSON.stringify(sendData));
                            
                            // Êõ¥Êñ∞AIÊ∂àÊÅØÁä∂ÊÄÅÔºå‰øùÊåÅthinkingÁä∂ÊÄÅÁõ¥Âà∞Êî∂Âà∞ÂìçÂ∫î
                            messages.value[aiMessageIndex] = {
                                role: 'ai',
                                content: '',
                                thinking: true,
                                isThinking: false,
                                thinkingProcess: '',
                                usedSearch: webSearchEnabled.value,
                                usedVision: hasImages
                            };
                        } catch (error) {
                            console.error('WebSocketÂèëÈÄÅÊ∂àÊÅØÊó∂Âá∫Èîô:', error);
                            useWebSocket.value = false;
                            // Â¶ÇÊûúWebSocketÂ§±Ë¥•ÔºåÂ∞ùËØïHTTP
                            sendWithHttp(sendData, aiMessageIndex, hasImages);
                        }
                    } else {
                        // ‰ΩøÁî®HTTPËØ∑Ê±Ç
                        sendWithHttp(sendData, aiMessageIndex, hasImages);
                    }
                }
                
                // ‰ΩøÁî®HTTPËØ∑Ê±ÇÂèëÈÄÅÊ∂àÊÅØ
                async function sendWithHttp(message, aiMessageIndex, hasImages) {
                    try {
                        // ‰ΩøÁî®ÊµÅÂºèAPI
                        const response = await fetch(`${apiBaseUrl}/chat/stream`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message: message,
                                web_search: webSearchEnabled.value,
                                deep_thinking: deepThinkingEnabled.value,
                                model: selectedModel.value.id,
                                conversation_id: currentConversationId.value,
                                images: hasImages ? [] : undefined
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }

                        // ÂàõÂª∫ËØªÂèñÂô®ÂíåËß£Á†ÅÂô®Â§ÑÁêÜÊµÅ
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let aiResponse = '';

                        // ÁßªÈô§ÊÄùËÄÉÁä∂ÊÄÅ
                        messages.value[aiMessageIndex] = {
                            role: 'ai',
                            content: '',
                            usedSearch: webSearchEnabled.value,
                            usedVision: hasImages
                        };

                        // ËØªÂèñÊµÅ
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            // Ëß£Á†ÅÂπ∂Ê∑ªÂä†Âà∞ÂìçÂ∫î
                            const chunk = decoder.decode(value, { stream: true });
                            aiResponse += chunk;
                            messages.value[aiMessageIndex].content = aiResponse;
                            scrollToBottom();
                        }

                        // Êõ¥Êñ∞ÂØπËØùÂàóË°®
                        fetchConversations();
                    } catch (error) {
                        console.error('ÂèëÈÄÅÊ∂àÊÅØÊó∂Âá∫Èîô:', error);
                        messages.value[aiMessageIndex] = {
                            role: 'ai',
                            content: 'ÂæàÊä±Ê≠âÔºåÂèëÁîü‰∫ÜÈîôËØØ„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇ',
                            usedSearch: webSearchEnabled.value,
                            usedVision: hasImages
                        };
                    } finally {
                        isLoading.value = false;
                        scrollToBottom();
                    }
                }

                function handleEnterKey(e) {
                    if (e.shiftKey) {
                        // Shift+EnterÂÖÅËÆ∏Êç¢Ë°å
                        return;
                    }
                    sendMessage();
                }

                // Ëé∑ÂèñÊâÄÊúâÂØπËØù
                async function fetchConversations() {
                    try {
                        const response = await fetch(`${apiBaseUrl}/conversations`);
                        if (response.ok) {
                            chatHistory.value = await response.json();
                            
                            // Â¶ÇÊûúÊúâÂØπËØùÔºåÂä†ËΩΩÁ¨¨‰∏Ä‰∏™
                            if (chatHistory.value.length > 0) {
                                loadChat(chatHistory.value[0].id);
                            } else {
                                // Â¶ÇÊûúÊ≤°ÊúâÂØπËØùÔºåÂàõÂª∫‰∏Ä‰∏™Êñ∞ÂØπËØù
                                createNewConversation();
                            }
                        } else {
                            console.error('Ëé∑ÂèñÂØπËØùÂàóË°®Â§±Ë¥•');
                        }
                    } catch (error) {
                        console.error('Ëé∑ÂèñÂØπËØùÂàóË°®Êó∂Âá∫Èîô:', error);
                    }
                }
                
                // ÂàõÂª∫Êñ∞ÂØπËØù
                async function createNewConversation() {
                    try {
                        const response = await fetch(`${apiBaseUrl}/conversations`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const newConversation = await response.json();
                            // Ê∑ªÂä†Âà∞ÂØπËØùÂàóË°®Âπ∂Âä†ËΩΩ
                            chatHistory.value.unshift(newConversation);
                            loadChat(newConversation.id);
                        }
                    } catch (error) {
                        console.error('ÂàõÂª∫Êñ∞ÂØπËØùÊó∂Âá∫Èîô:', error);
                    }
                }
                
                // Âä†ËΩΩÂØπËØù
                async function loadChat(conversationId) {
                    try {
                        // Ëé∑ÂèñÂØπËØùÊ∂àÊÅØ
                        const response = await fetch(`${apiBaseUrl}/conversations/${conversationId}/messages`);
                        if (response.ok) {
                            const conversationMessages = await response.json();
                            messages.value = [];
                            
                            // Â∞ÜÊ∂àÊÅØËΩ¨Êç¢‰∏∫ÂâçÁ´ØÈúÄË¶ÅÁöÑÊ†ºÂºè
                            conversationMessages.forEach(msg => {
                                messages.value.push({
                                    role: 'user',
                                    content: msg.user_message
                                });
                                messages.value.push({
                                    role: 'ai',
                                    content: msg.ai_message
                                });
                            });
                            
                            // Êõ¥Êñ∞ÂΩìÂâçÂØπËØùID
                            currentConversationId.value = conversationId;
                            
                            // Êõ¥Êñ∞Ê¥ªÂä®ÂØπËØùÁä∂ÊÄÅ
                            const index = chatHistory.value.findIndex(c => c.id === conversationId);
                            if (index !== -1) {
                                currentChatIndex.value = index;
                            }
                            
                            scrollToBottom();
                        }
                    } catch (error) {
                        console.error('Âä†ËΩΩÂØπËØùÊ∂àÊÅØÊó∂Âá∫Èîô:', error);
                    }
                }
                
                // ÈáçÂëΩÂêçÂØπËØù
                async function renameConversation(conversationId, newTitle) {
                    try {
                        const response = await fetch(`${apiBaseUrl}/conversations/${conversationId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: newTitle
                            })
                        });
                        
                        if (response.ok) {
                            // Êõ¥Êñ∞ÂØπËØùÂàóË°®‰∏≠ÁöÑÊ†áÈ¢ò
                            const index = chatHistory.value.findIndex(c => c.id === conversationId);
                            if (index !== -1) {
                                chatHistory.value[index].title = newTitle;
                            }
                        }
                    } catch (error) {
                        console.error('ÈáçÂëΩÂêçÂØπËØùÊó∂Âá∫Èîô:', error);
                    }
                }
                
                // ÁîüÊàêÈöèÊú∫ÂêçÁß∞
                async function generateRandomName() {
                    try {
                        const response = await fetch(`${apiBaseUrl}/random-name`);
                        if (response.ok) {
                            const data = await response.json();
                            return data.name;
                        }
                    } catch (error) {
                        console.error('ÁîüÊàêÈöèÊú∫ÂêçÁß∞Êó∂Âá∫Èîô:', error);
                    }
                    return 'Êñ∞ÂØπËØù';
                }
                
                // ÂàõÂª∫Êñ∞ÂØπËØùÂπ∂ÁîüÊàêÈöèÊú∫ÂêçÁß∞
                async function startNewChat() {
                    try {
                        // ËØªÂèñÈöèÊú∫ÂêçÁß∞
                        const name = await generateRandomName();
                        
                        // ÂàõÂª∫ÂØπËØù
                        const response = await fetch(`${apiBaseUrl}/conversations`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: name
                            })
                        });
                        
                        if (response.ok) {
                            const newConversation = await response.json();
                            // Ê∑ªÂä†Âà∞ÂØπËØùÂàóË°®Âπ∂Âä†ËΩΩ
                            chatHistory.value.unshift(newConversation);
                            loadChat(newConversation.id);
                        }
                    } catch (error) {
                        console.error('ÂàõÂª∫Êñ∞ÂØπËØùÊó∂Âá∫Èîô:', error);
                    }
                }

                async function fetchKnowledgeFiles() {
                    try {
                        const response = await fetch(`${apiBaseUrl}/knowledge/files`);
                        if (response.ok) {
                            knowledgeFiles.value = await response.json();
                        }
                    } catch (error) {
                        console.error('Ëé∑ÂèñÁü•ËØÜÂ∫ìÊñá‰ª∂ÂàóË°®Â§±Ë¥•:', error);
                    }
                }
                
                // Ëé∑ÂèñÂèØÁî®Ê®°Âûã
                async function fetchAvailableModels() {
                    try {
                        const response = await fetch(`${apiBaseUrl}/models`);
                        if (response.ok) {
                            const data = await response.json();
                            const models = data.models || data; // ÂÖºÂÆπ‰∏§ÁßçÊ†ºÂºè
                            availableModels.value = models;
                            
                            // ËÆæÁΩÆÈªòËÆ§Ê®°Âûã
                            if (models.length > 0) {
                                const defaultModel = models.find(m => m.id === 'qwen-max') || models[0];
                                selectedModel.value = defaultModel;
                            }
                            
                            console.log('ÂèØÁî®Ê®°ÂûãÂä†ËΩΩÊàêÂäü:', models);
                        } else {
                            console.error('Ëé∑ÂèñÊ®°ÂûãÂàóË°®Â§±Ë¥•:', response.status);
                        }
                    } catch (error) {
                        console.error('Ëé∑ÂèñÊ®°ÂûãÂàóË°®Êó∂Âá∫Èîô:', error);
                        // ‰ΩøÁî®ÈªòËÆ§Ê®°ÂûãÈÖçÁΩÆ
                        console.log('‰ΩøÁî®ÈªòËÆ§Ê®°ÂûãÈÖçÁΩÆ');
                    }
                }
                
                // Âà†Èô§Áü•ËØÜÂ∫ìÊñá‰ª∂
                async function deleteKnowledgeFile(fileId, filename) {
                    const shouldDelete = safeConfirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Êñá‰ª∂„Äå${filename}„ÄçÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`);
                    if (!shouldDelete) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${apiBaseUrl}/knowledge/files/${fileId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                // Âà∑Êñ∞Áü•ËØÜÂ∫ìÊñá‰ª∂ÂàóË°®
                                await fetchKnowledgeFiles();
                                // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                                alert(`Êñá‰ª∂„Äå${filename}„ÄçÂ∑≤ÊàêÂäüÂà†Èô§`); 
                            } else {
                                alert(`Âà†Èô§Â§±Ë¥•: ${result.message || 'Êú™Áü•ÈîôËØØ'}`); 
                            }
                        } else {
                            alert('Âà†Èô§Êñá‰ª∂Â§±Ë¥•: ÊúçÂä°Âô®ÂìçÂ∫îÈîôËØØ');
                        }
                    } catch (error) {
                        console.error('Âà†Èô§Áü•ËØÜÂ∫ìÊñá‰ª∂Êó∂Âá∫Èîô:', error);
                        alert('Âà†Èô§Êñá‰ª∂Êó∂ÂèëÁîüÈîôËØØÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞Êó•Âøó');
                    }
                }

                // Êñá‰ª∂‰∏ä‰º†Áõ∏ÂÖ≥ÊñπÊ≥ï
                function triggerFileInput() {
                    fileInput.value.click();
                }

                function onFileSelected(event) {
                    const files = event.target.files;
                    if (files.length > 0) {
                        for (let i = 0; i < files.length; i++) {
                            selectedFiles.value.push(files[i]);
                        }
                    }
                }

                function onDragOver(event) {
                    isDragOver.value = true;
                }

                function onDragLeave(event) {
                    isDragOver.value = false;
                }

                function onFileDrop(event) {
                    isDragOver.value = false;
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        for (let i = 0; i < files.length; i++) {
                            selectedFiles.value.push(files[i]);
                        }
                    }
                }

                function removeFile(index) {
                    selectedFiles.value.splice(index, 1);
                }

                async function uploadFiles() {
                    if (selectedFiles.value.length === 0 || isUploading.value) return;
                    
                    isUploading.value = true;
                    const fileCount = selectedFiles.value.length; // ‰øùÂ≠òÊñá‰ª∂Êï∞Èáè
                    
                    try {
                        for (const file of selectedFiles.value) {
                            const formData = new FormData();
                            formData.append('file', file);
                            
                            const response = await fetch(`${apiBaseUrl}/upload`, {
                                method: 'POST',
                                body: formData
                            });
                            
                            if (!response.ok) {
                                throw new Error(`‰∏ä‰º†Â§±Ë¥•: ${response.statusText}`);
                            }
                        }
                        
                        // Âà∑Êñ∞Áü•ËØÜÂ∫ìÊñá‰ª∂ÂàóË°®
                        await fetchKnowledgeFiles();
                        
                        // ÂÖ≥Èó≠‰∏ä‰º†ÂØπËØùÊ°Ü
                        toggleFileUpload();
                        
                        // Êñá‰ª∂‰∏ä‰º†ÊàêÂäüÔºå‰∏çÊòæÁ§∫Á≥ªÁªüÊ∂àÊÅØ
                        // Áî®Êà∑ÂèØ‰ª•Áõ¥Êé•ÂºÄÂßãËØ¢ÈóÆÂÖ≥‰∫éÊñá‰ª∂ÁöÑÂÜÖÂÆπ
                        
                    } catch (error) {
                        console.error('‰∏ä‰º†Êñá‰ª∂Êó∂Âá∫Èîô:', error);
                        alert('‰∏ä‰º†Êñá‰ª∂Êó∂Âá∫Èîô: ' + error.message);
                    } finally {
                        isUploading.value = false;
                    }
                }

                // Âà†Èô§ÂØπËØù
                async function deleteConversation(conversationId, event) {
                    // ÂÆâÂÖ®Âú∞ÈòªÊ≠¢ÁÇπÂáª‰∫ã‰ª∂‰º†Êí≠
                    safeStopPropagation(event);
                    
                    // ‰ΩøÁî®ÂÆâÂÖ®ÁöÑÁ°ÆËÆ§ÊñπÂºè
                    const shouldDelete = safeConfirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂØπËØùÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ');
                    if (!shouldDelete) {
                        console.log('Áî®Êà∑ÂèñÊ∂àÂà†Èô§Êìç‰Ωú');
                        return;
                    }
                    
                    try {
                        console.log('ÂºÄÂßãÂà†Èô§ÂØπËØù:', conversationId);
                        const response = await fetch(`${apiBaseUrl}/conversations/${conversationId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        console.log('Âà†Èô§ÂìçÂ∫î:', result);
                        
                        if (result.success) {
                            // ‰ªéÂàóË°®‰∏≠ÁßªÈô§
                            chatHistory.value = chatHistory.value.filter(chat => chat.id !== conversationId);
                            console.log('ÂØπËØùÂà†Èô§ÊàêÂäüÔºåÂâ©‰ΩôÂØπËØùÊï∞:', chatHistory.value.length);
                            
                            // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÂØπËØùÔºåË∑≥ËΩ¨Âà∞Âè¶‰∏Ä‰∏™ÂØπËØùÊàñÂàõÂª∫Êñ∞ÂØπËØù
                            if (currentConversationId.value === conversationId) {
                                if (chatHistory.value.length > 0) {
                                    loadChat(chatHistory.value[0].id);
                                } else {
                                    startNewChat();
                                }
                            }
                        } else {
                            console.error('Âà†Èô§ÂØπËØùÂ§±Ë¥•:', result.message);
                            errorMessage.value = `Âà†Èô§ÂØπËØùÂ§±Ë¥•: ${result.message}`;
                            setTimeout(() => {
                                errorMessage.value = '';
                            }, 5000);
                        }
                    } catch (error) {
                        console.error('Âà†Èô§ÂØπËØùÊó∂Âá∫Èîô:', error);
                        errorMessage.value = 'Âà†Èô§ÂØπËØùÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï';
                        setTimeout(() => {
                            errorMessage.value = '';
                        }, 5000);
                    }
                }

                // ÂºÄÂßãÈáçÂëΩÂêçÂØπËØù
                function startRenameConversation(conversationId, currentTitle, event) {
                    safeStopPropagation(event);
                    console.log('ÂºÄÂßãÈáçÂëΩÂêçÂØπËØù:', conversationId, currentTitle);
                    isRenaming.value = true;
                    renamingId.value = conversationId;
                    newTitle.value = currentTitle || '';
                    
                    // ‰ΩøÁî®setTimeoutÁ°Æ‰øùÂú®DOMÊõ¥Êñ∞ÂêéËÅöÁÑ¶ËæìÂÖ•Ê°Ü
                    setTimeout(() => {
                        const inputElement = document.getElementById(`rename-input-${conversationId}`);
                        if (inputElement) {
                            inputElement.focus();
                            inputElement.select(); // ÈÄâ‰∏≠ÊâÄÊúâÊñáÊú¨
                        }
                    }, 50);
                }
                
                // ÂèñÊ∂àÈáçÂëΩÂêç
                function cancelRename() {
                    isRenaming.value = false;
                    renamingId.value = null;
                    newTitle.value = '';
                }
                
                // Á°ÆËÆ§ÈáçÂëΩÂêç
                async function confirmRename() {
                    if (!newTitle.value.trim()) {
                        errorMessage.value = 'ÂØπËØùÊ†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫';
                        setTimeout(() => {
                            errorMessage.value = '';
                        }, 3000);
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${apiBaseUrl}/conversations/${renamingId.value}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: newTitle.value.trim()
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // Êõ¥Êñ∞ÂØπËØùÂàóË°®‰∏≠ÁöÑÊ†áÈ¢ò
                            const conversation = chatHistory.value.find(chat => chat.id === renamingId.value);
                            if (conversation) {
                                conversation.title = newTitle.value.trim();
                            }
                            console.log('ÂØπËØùÈáçÂëΩÂêçÊàêÂäü');
                        } else {
                            console.error('ÈáçÂëΩÂêçÂ§±Ë¥•:', result.message);
                            errorMessage.value = `ÈáçÂëΩÂêçÂ§±Ë¥•: ${result.message}`;
                            setTimeout(() => {
                                errorMessage.value = '';
                            }, 5000);
                        }
                    } catch (error) {
                        console.error('ÈáçÂëΩÂêçÂØπËØùÊó∂Âá∫Èîô:', error);
                        errorMessage.value = 'ÈáçÂëΩÂêçÂØπËØùÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï';
                        setTimeout(() => {
                            errorMessage.value = '';
                        }, 5000);
                    } finally {
                        // Êó†ËÆ∫ÊàêÂäüÊàñÂ§±Ë¥•ÈÉΩÈáçÁΩÆÈáçÂëΩÂêçÁä∂ÊÄÅ
                        isRenaming.value = false;
                        renamingId.value = null;
                        newTitle.value = '';
                    }
                }
                
                // ÂÅúÊ≠¢ÂΩìÂâçÂØπËØùÁîüÊàê
                function stopGeneration() {
                    console.log('Áî®Êà∑ËØ∑Ê±ÇÂÅúÊ≠¢ÁîüÊàê');
                    if (ws.value && ws.value.readyState === WebSocket.OPEN) {
                        try {
                            ws.value.send(JSON.stringify({ action: 'stop' }));
                            console.log('Â∑≤ÂèëÈÄÅÂÅúÊ≠¢ËØ∑Ê±ÇÂà∞ÊúçÂä°Âô®');
                        } catch (error) {
                            console.error('ÂèëÈÄÅÂÅúÊ≠¢ËØ∑Ê±ÇÊó∂Âá∫Èîô:', error);
                        }
                    }
                    
                    // Á´ãÂç≥Êõ¥Êñ∞UIÁä∂ÊÄÅ
                    isLoading.value = false;
                    
                    // Â¶ÇÊûúÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÊòØAIÊ∂àÊÅØ‰∏îÊ≠£Âú®ÊÄùËÄÉÔºåÁßªÈô§ÊÄùËÄÉÁä∂ÊÄÅ
                    const lastMessage = messages.value[messages.value.length - 1];
                    if (lastMessage && lastMessage.role === 'ai' && lastMessage.thinking) {
                        lastMessage.thinking = false;
                        if (!lastMessage.content) {
                            lastMessage.content = 'ÂØπËØùÂ∑≤ÂÅúÊ≠¢';
                        } else {
                            lastMessage.content += '\n\n[ÂØπËØùÂ∑≤ÂÅúÊ≠¢]';
                        }
                    }
                }

                // Êñ∞Â¢ûÂäüËÉΩÂáΩÊï∞
                
                // ÂàáÊç¢ËßÜËßâÊ®°Âºè
                function toggleVisionMode() {
                    visionModeEnabled.value = !visionModeEnabled.value;
                    if (visionModeEnabled.value) {
                        // Ëá™Âä®ÂàáÊç¢Âà∞ËßÜËßâÊ®°Âûã
                        const visionModel = availableModels.value.find(m => m.id === 'qwen-vl-max');
                        if (visionModel) {
                            selectedModel.value = visionModel;
                        }
                        // Ëß¶ÂèëÂõæÁâá‰∏ä‰º†
                        triggerImageUpload();
                    }
                }
                
                // Ëß¶ÂèëÊñáÊ°£‰∏ä‰º†
                function triggerDocumentUpload() {
                    documentInput.value.click();
                }
                
                // Â§ÑÁêÜÊñáÊ°£ÈÄâÊã©
                function onDocumentSelected(event) {
                    const files = event.target.files;
                    if (files.length > 0) {
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            uploadedFiles.value.push(file);
                        }
                    }
                    // Ê∏ÖÁ©∫inputÂÄºÔºåÂÖÅËÆ∏ÈáçÂ§çÈÄâÊã©Âêå‰∏ÄÊñá‰ª∂
                    event.target.value = '';
                }
                
                // ÁßªÈô§‰∏ä‰º†ÁöÑÊñá‰ª∂
                function removeUploadedFile(index) {
                    uploadedFiles.value.splice(index, 1);
                }
                
                // ÂºÄÂßãÊà™ÂõæÊçïËé∑
                function startScreenCapture() {
                    isScreenshotMode.value = true;
                    selectionRect.value = null;
                    
                    // Ê∑ªÂä†ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨
                    document.addEventListener('keydown', handleScreenshotKeydown);
                }
                
                // Â§ÑÁêÜÊà™ÂõæÈîÆÁõò‰∫ã‰ª∂
                function handleScreenshotKeydown(event) {
                    if (event.key === 'Escape') {
                        cancelScreenshot();
                    }
                }
                
                // ÂèñÊ∂àÊà™Âõæ
                function cancelScreenshot() {
                    isScreenshotMode.value = false;
                    selectionRect.value = null;
                    document.removeEventListener('keydown', handleScreenshotKeydown);
                }
                
                // ÂºÄÂßãÈÄâÊã©Âå∫Âüü
                function startSelection(event) {
                    if (!isScreenshotMode.value) return;
                    
                    const rect = {
                        startX: event.clientX,
                        startY: event.clientY,
                        endX: event.clientX,
                        endY: event.clientY
                    };
                    selectionRect.value = rect;
                }
                
                // Êõ¥Êñ∞ÈÄâÊã©Âå∫Âüü
                function updateSelection(event) {
                    if (!isScreenshotMode.value || !selectionRect.value) return;
                    
                    selectionRect.value.endX = event.clientX;
                    selectionRect.value.endY = event.clientY;
                }
                
                // ÁªìÊùüÈÄâÊã©Âå∫Âüü
                async function endSelection(event) {
                    if (!isScreenshotMode.value || !selectionRect.value) return;
                    
                    const rect = selectionRect.value;
                    const width = Math.abs(rect.endX - rect.startX);
                    const height = Math.abs(rect.endY - rect.startY);
                    
                    if (width < 10 || height < 10) {
                        cancelScreenshot();
                        return;
                    }
                    
                    try {
                        // ‰ΩøÁî®html2canvasÊà™ÂèñÈÄâÂÆöÂå∫Âüü
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // ËÆæÁΩÆcanvasÂ∞∫ÂØ∏
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Êà™ÂèñÂ±èÂπïÂÜÖÂÆπÔºàËøôÈáåÈúÄË¶ÅÁî®Êà∑ÊéàÊùÉÔºâ
                        if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                            const stream = await navigator.mediaDevices.getDisplayMedia({
                                video: { mediaSource: 'screen' }
                            });
                            
                            const video = document.createElement('video');
                            video.srcObject = stream;
                            video.play();
                            
                            video.addEventListener('loadedmetadata', () => {
                                // ËÆ°ÁÆóÊà™ÂõæÂå∫Âüü
                                const x = Math.min(rect.startX, rect.endX);
                                const y = Math.min(rect.startY, rect.endY);
                                
                                // ÁªòÂà∂Êà™ÂõæÂå∫Âüü
                                ctx.drawImage(video, x, y, width, height, 0, 0, width, height);
                                
                                // ÂÅúÊ≠¢ËßÜÈ¢ëÊµÅ
                                stream.getTracks().forEach(track => track.stop());
                                
                                // Â∞ÜcanvasËΩ¨Êç¢‰∏∫blobÂπ∂Ê∑ªÂä†Âà∞‰∏ä‰º†ÂõæÁâá
                                canvas.toBlob((blob) => {
                                    const reader = new FileReader();
                                    reader.onload = (e) => {
                                        uploadedImages.value.push({
                                            file: blob,
                                            url: e.target.result,
                                            name: `Êà™Âõæ_${new Date().toLocaleString()}.png`,
                                            size: blob.size
                                        });
                                        
                                        // Ëá™Âä®ÂêØÁî®ËßÜËßâÊ®°Âºè
                                        visionModeEnabled.value = true;
                                        const visionModel = availableModels.value.find(m => m.id === 'qwen-vl-max');
                                        if (visionModel) {
                                            selectedModel.value = visionModel;
                                        }
                                    };
                                    reader.readAsDataURL(blob);
                                }, 'image/png');
                                
                                cancelScreenshot();
                            });
                        } else {
                            alert('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÂ±èÂπïÊà™ÂõæÂäüËÉΩ');
                            cancelScreenshot();
                        }
                    } catch (error) {
                        console.error('Êà™ÂõæÂ§±Ë¥•:', error);
                        alert('Êà™ÂõæÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ');
                        cancelScreenshot();
                    }
                }
                
                // ËÆ°ÁÆóÈÄâÊã©Âå∫ÂüüÊ†∑Âºè
                const selectionStyle = computed(() => {
                    if (!selectionRect.value) return {};
                    
                    const rect = selectionRect.value;
                    const left = Math.min(rect.startX, rect.endX);
                    const top = Math.min(rect.startY, rect.endY);
                    const width = Math.abs(rect.endX - rect.startX);
                    const height = Math.abs(rect.endY - rect.startY);
                    
                    return {
                        left: `${left}px`,
                        top: `${top}px`,
                        width: `${width}px`,
                        height: `${height}px`
                    };
                });
                
                // ÈáçÂÜôtriggerImageUploadÂáΩÊï∞
                function triggerImageUpload() {
                    imageInput.value.click();
                }

                return {
                    userInput,
                    messages,
                    chatHistory,
                    currentChatIndex,
                    currentConversationId,
                    webSearchEnabled,
                    deepThinkingEnabled,
                    uploadedImages,
                    uploadedFiles,
                    visionModeEnabled,
                    showPasteHint,
                    showModelDropdown,
                    selectedModel,
                    availableModels,
                    isLoading,
                    showFileUpload,
                    selectedFiles,
                    isDragOver,
                    isUploading,
                    knowledgeFiles,
                    isRenaming,
                    renamingId,
                    newTitle,
                    chatMessages,
                    messageInput,
                    fileInput,
                    imageInput,
                    documentInput,
                    errorMessage,
                    ws,
                    useWebSocket,
                    getTimeBasedGreeting,
                    adjustTextareaHeight,
                    formatMessage,
                    formatDate,
                    formatFileSize,
                    getFileIcon,
                    getFileExtension,
                    usePrompt,
                    toggleWebSearch,
                    toggleDeepThinking,
                    toggleModelDropdown,
                    selectModel,
                    triggerImageUpload,
                    onImageSelected,
                    removeUploadedImage,
                    handlePaste,
                    toggleFileUpload,
                    sendMessage,
                    handleEnterKey,
                    startNewChat,
                    loadChat,
                    deleteConversation,
                    startRenameConversation,
                    confirmRename,
                    cancelRename,
                    stopGeneration,
                    deleteKnowledgeFile,
                    triggerFileInput,
                    onFileSelected,
                    onDragOver,
                    onDragLeave,
                    onFileDrop,
                    removeFile,
                    uploadFiles,
                    toggleVisionMode,
                    onDocumentSelected,
                    removeUploadedFile
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
